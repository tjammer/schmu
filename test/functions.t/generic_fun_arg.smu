external printi : int -> unit

type t 'a = { x : 'a }

-- This function is generic
function apply(x: 'a, f : 'a -> 'b)
  f(x)

a = 2

function add_closed(x)
  -- we close over a
  x + a

-- simple int -> int
function add1(x)
  x + 1

function print_bool(b)
  if b then printi(1)
  else printi(0)

-- simple bool -> bool
function makefalse(b)
  if b then false
  else b

-- bool t -> bool t
function make_rec_false(r)
  if r.x then { x = false }
  else r

-- simple t -> t
function add3_rec(t)
  { x = t.x + 3 }

-- A polymorphic function which will get monomorphized
f = function (x) x

printi(apply(20, add1)) >>
printi(apply(20, add_closed)) >>
printi(apply({ x = 20 }, add3_rec).x) >>
print_bool(apply({ x = true }, make_rec_false).x) >>
print_bool(apply(true, makefalse)) >>
printi(f({ x = 17 }).x) >>
-- inline polymorphic function
printi(function (x) x end(18))
